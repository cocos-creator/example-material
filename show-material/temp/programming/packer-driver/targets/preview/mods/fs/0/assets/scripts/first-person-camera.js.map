{"version":3,"sources":["file:///D:/material-examples/show-material/assets/scripts/first-person-camera.ts"],"names":["_decorator","Component","Quat","Vec2","Vec3","macro","systemEvent","SystemEvent","game","ccclass","property","v2_1","v2_2","v3_1","qt_1","KEYCODE","W","charCodeAt","S","A","D","Q","E","SHIFT","KEY","shift","FirstPersonCamera","slide","range","onLoad","on","EventType","MOUSE_WHEEL","onMouseWheel","KEY_DOWN","onKeyDown","KEY_UP","onKeyUp","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","copy","_euler","node","eulerAngles","_position","position","onDestroy","off","update","dt","transformQuat","_velocity","rotation","scaleAndAdd","moveSpeed","_speedScale","lerp","damp","setPosition","fromEuler","x","y","z","slerp","setRotation","e","delta","getScrollY","UNIT_Z","v","keyCode","moveSpeedShiftScale","canvas","requestPointerLock","getStartLocation","width","getDelta","rotateSpeed","getLocation","subtract","document","exitPointerLock"],"mappings":"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","sourcesContent":["import { _decorator, Component, Quat, Vec2, Vec3, macro, systemEvent, SystemEvent, game, Touch, EventKeyboard, EventMouse } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst v2_1 = new Vec2();\r\nconst v2_2 = new Vec2();\r\nconst v3_1 = new Vec3();\r\nconst qt_1 = new Quat();\r\nconst KEYCODE = {\r\n    W: 'W'.charCodeAt(0),\r\n    S: 'S'.charCodeAt(0),\r\n    A: 'A'.charCodeAt(0),\r\n    D: 'D'.charCodeAt(0),\r\n    Q: 'Q'.charCodeAt(0),\r\n    E: 'E'.charCodeAt(0),\r\n    SHIFT: macro.KEY.shift,\r\n};\r\n\r\n@ccclass\r\nexport class FirstPersonCamera extends Component {\r\n\r\n    @property\r\n    public moveSpeed = 1;\r\n\r\n    @property\r\n    public moveSpeedShiftScale = 5;\r\n\r\n    @property({ slide: true, range: [0.05, 0.5, 0.01] })\r\n    public damp = 0.2;\r\n\r\n    @property\r\n    public rotateSpeed = 1;\r\n\r\n    private _euler = new Vec3();\r\n    private _velocity = new Vec3();\r\n    private _position = new Vec3();\r\n    private _speedScale = 1;\r\n\r\n    public onLoad () {\r\n        systemEvent.on(SystemEvent.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\r\n        systemEvent.on(SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\r\n        systemEvent.on(SystemEvent.EventType.KEY_UP, this.onKeyUp, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_START, this.onTouchStart, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_END, this.onTouchEnd, this);\r\n        Vec3.copy(this._euler, this.node.eulerAngles);\r\n        Vec3.copy(this._position, this.node.position);\r\n    }\r\n\r\n    public onDestroy () {\r\n        systemEvent.off(SystemEvent.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\r\n        systemEvent.off(SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\r\n        systemEvent.off(SystemEvent.EventType.KEY_UP, this.onKeyUp, this);\r\n        systemEvent.off(SystemEvent.EventType.TOUCH_START, this.onTouchStart, this);\r\n        systemEvent.off(SystemEvent.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        systemEvent.off(SystemEvent.EventType.TOUCH_END, this.onTouchEnd, this);\r\n    }\r\n\r\n    public update (dt: number) {\r\n        // position\r\n        Vec3.transformQuat(v3_1, this._velocity, this.node.rotation);\r\n        Vec3.scaleAndAdd(this._position, this._position, v3_1, this.moveSpeed * this._speedScale);\r\n        Vec3.lerp(v3_1, this.node.position, this._position, dt / this.damp);\r\n        this.node.setPosition(v3_1);\r\n        // rotation\r\n        Quat.fromEuler(qt_1, this._euler.x, this._euler.y, this._euler.z);\r\n        Quat.slerp(qt_1, this.node.rotation, qt_1, dt / this.damp);\r\n        this.node.setRotation(qt_1);\r\n    }\r\n\r\n    public onMouseWheel (e: EventMouse) {\r\n        const delta = -e.getScrollY() * this.moveSpeed * 0.1; // delta is positive when scroll down\r\n        Vec3.transformQuat(v3_1, Vec3.UNIT_Z, this.node.rotation);\r\n        Vec3.scaleAndAdd(this._position, this.node.position, v3_1, delta);\r\n    }\r\n\r\n    public onKeyDown (e: EventKeyboard) {\r\n        const v = this._velocity;\r\n        if      (e.keyCode === KEYCODE.SHIFT) { this._speedScale = this.moveSpeedShiftScale; }\r\n        else if (e.keyCode === KEYCODE.W) { if (v.z === 0) { v.z = -1; } }\r\n        else if (e.keyCode === KEYCODE.S) { if (v.z === 0) { v.z =  1; } }\r\n        else if (e.keyCode === KEYCODE.A) { if (v.x === 0) { v.x = -1; } }\r\n        else if (e.keyCode === KEYCODE.D) { if (v.x === 0) { v.x =  1; } }\r\n        else if (e.keyCode === KEYCODE.Q) { if (v.y === 0) { v.y = -1; } }\r\n        else if (e.keyCode === KEYCODE.E) { if (v.y === 0) { v.y =  1; } }\r\n    }\r\n\r\n    public onKeyUp (e: EventKeyboard) {\r\n        const v = this._velocity;\r\n        if      (e.keyCode === KEYCODE.SHIFT) { this._speedScale = 1; }\r\n        else if (e.keyCode === KEYCODE.W) { if (v.z < 0) { v.z = 0; } }\r\n        else if (e.keyCode === KEYCODE.S) { if (v.z > 0) { v.z = 0; } }\r\n        else if (e.keyCode === KEYCODE.A) { if (v.x < 0) { v.x = 0; } }\r\n        else if (e.keyCode === KEYCODE.D) { if (v.x > 0) { v.x = 0; } }\r\n        else if (e.keyCode === KEYCODE.Q) { if (v.y < 0) { v.y = 0; } }\r\n        else if (e.keyCode === KEYCODE.E) { if (v.y > 0) { v.y = 0; } }\r\n    }\r\n\r\n    public onTouchStart (e: Touch) {\r\n        if (game.canvas.requestPointerLock) { game.canvas.requestPointerLock(); }\r\n    }\r\n\r\n    public onTouchMove (e: Touch) {\r\n        e.getStartLocation(v2_1);\r\n        if (v2_1.x > game.canvas.width * 0.4) { // rotation\r\n            e.getDelta(v2_2);\r\n            this._euler.y -= v2_2.x * this.rotateSpeed * 0.1;\r\n            this._euler.x += v2_2.y * this.rotateSpeed * 0.1;\r\n        } else { // position\r\n            e.getLocation(v2_2);\r\n            Vec2.subtract(v2_2, v2_2, v2_1);\r\n            this._velocity.x = v2_2.x * 0.01;\r\n            this._velocity.z = -v2_2.y * 0.01;\r\n        }\r\n    }\r\n\r\n    public onTouchEnd (e: Touch) {\r\n        if (document.exitPointerLock) { document.exitPointerLock(); }\r\n        e.getStartLocation(v2_1);\r\n        if (v2_1.x < game.canvas.width * 0.4) { // position\r\n            this._velocity.x = 0;\r\n            this._velocity.z = 0;\r\n        }\r\n    }\r\n}\r\n"]}